---
title: "Downscaling snowpack variability in western North America"
subtitle: "Models and Observations"
author: "Nick Gauthier"
date: "Last knit on: `r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
link-citations: yes
---

Downscaling snow water equivalent 

# Introduction


Import the packages required for this analysis.

```{r setup}
knitr::opts_chunk$set(fig.width = 6, fig.asp = 0.618)

# analysis
library(raster) # processing raster data
library(tidyverse) # data manipulation and visualization
library(mgcv) # flexible nonlinear regression models
library(remote) # empirical orthogonal teleconnections
library(modelr)

# plotting
library(sf) # shapefiles and plotting
library(gganimate) # animated gifs
library(magick) # for multi-panel animations
library(scico) # color palettes
library(patchwork)


# this package
devtools::load_all()

load('../data.Rdata')
```
 
# Snowpack in the western US
 
First plot March SWE climatology from observations and reanalysis data. We immediately see the mismatch between the two because of the coarse resolution reanalysis. To drive home the point, here's the high-resolution observations, resampled to the reanalysis resolution. For a better comparison, each dataset was reduced to the common range of 1982--2010. The coarse data fail to capture the topographic heterogeneity of the domain, and thus the small-scale variations in elevation and temperature that influence snow accumulation and melt.

```{r, echo = FALSE, fig.cap="A) Mean March SWE from PRISM/SNOTEL observations, 1982-2017. B) Mean March SWE from CERA-20C Reanalysis, 1901-2010. C) Standard deviation of March SWE from PRISM/SNOTEL observations, 1982-2017. B) Standard deviation of March SWE from CERA-20C Reanalysis, 1901-2010."}
a <- prism_dat %>%
  get_climatology() %>%
  ggplot() +
  geom_raster(aes(x, y, fill = swe_mean)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
   scale_fill_distiller(palette = 'Blues', direction = 1, name = 'SWE (mm)') +
  theme_void() +
  theme(legend.position = 'bottom')

b <- cera_dat %>%
  get_climatology() %>%
  ggplot() +
  geom_raster(aes(x, y, fill = swe_mean)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
   scale_fill_distiller(palette = 'Blues', direction = 1, name = 'SWE (mm)') +
  theme_void() +
  theme(legend.position = 'bottom')

a + b + plot_annotation(tag_levels = 'A')
```

```{r}
a <- prism_dat %>%
  get_climatology() %>%
  ggplot() +
  geom_raster(aes(x, y, fill = swe_mean)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'davos', direction = -1, name = 'SWE (mm)') +
  theme_void() +
  theme(legend.position = 'bottom')

b <- cera_dat %>%
  get_climatology() %>%
  ggplot() +
  geom_raster(aes(x, y, fill = swe_mean)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'davos', direction = -1, name = 'SWE (mm)') +
  theme_void() +
  theme(legend.position = 'bottom')

a + b + plot_annotation(tag_levels = 'A')
```

Next we'll look at how SWE has varied over time and space.


# Modes of Snowpack Variability

In spite of the mismatch in mean values, perhaps the *variability* in SWE from year to year has something in common.

```{r animation, echo = FALSE, warning=FALSE,cache = TRUE}
# code courtesy of https://github.com/thomasp85/gganimate/wiki/Animation-Composition
c <- prism_dat %>%
  filter(between(year, 1985, 2000)) %>%
  group_by(x, y) %>%
  mutate(anomaly = SWE - mean(SWE)) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = anomaly)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'vik', direction = -1, limits = c(-1800, 1800)) +
  transition_states(year) +
    ggtitle("March, {closest_state}", "Observed") +
  theme_void() +
  theme(legend.position = 'bottom')

d <- cera_dat %>%
  filter(between(year, 1985, 2000)) %>%
  group_by(x, y) %>%
  mutate(anomaly = SWE - mean(SWE)) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = anomaly)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'vik', direction = -1, limits = c(-110, 110)) +
  transition_states(year) +
  ggtitle("", "Simulated") +
  theme_void() +
  theme(legend.position = 'bottom')

c_gif <- gganimate::animate(c)
d_gif <- gganimate::animate(d)

c_mgif <- image_read(c_gif)
d_mgif <- image_read(d_gif)

new_gif <- image_append(c(c_mgif[1], d_mgif[1]))
for(i in 2:100){
  combined <- image_append(c(c_mgif[i], d_mgif[i]))
  new_gif <- c(new_gif, combined)
}

new_gif
```

## PCA

We can decompose all this year-to-year variability into the dominant spatial modes -- robust spatial anomaly patterns that tend to co-occur.

Run a principal components analysis. Get the eigenvalues, and run some truncation tests.

```{r, fig.width = 8, fig.asp = .4, echo = FALSE}
e <- prism_dat %>% 
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(NA)

f <- cera_dat %>% 
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(NA)

e + f
```

```{r}
dof_p <- prism_dat %>% 
  
  get_pcs() %>%
  get_eigenvalues() %>%
  pull(eigenvalues)

sum(dof_p)^2 / sum(dof_p^2) # from bretheron et al 1999

dof_c <- cera_dat %>% 
  get_pcs() %>%
  get_eigenvalues() %>%
  pull(eigenvalues)

sum(dof_c)^2 / sum(dof_c^2) # from bretheron et al 1999
```

Looks like there are ~4 spatial degrees of freedom in the data

### Pre-filtering and cross-validation

Set up a 5 fold cross validation experiment for selecting the truncation level, $k$, for each set of PCs.

```{r}
exp_test <- tibble(k_cera = 1:9, k_prism = 1:9) %>%
  mutate(cera_patterns = map(k_cera, ~get_patterns(cera_dat, k = .)),
         prism_patterns = map(k_prism, ~get_patterns(prism_dat, k = .)))
```

```{r}
cv_dat <- expand_grid(k_cera = exp_test$k_cera, 
                      k_prism = exp_test$k_prism) %>%
  mutate(cv = map2(k_cera, k_prism, fit_kfold))
```

#### Domain averages
```{r}
wus_stats <- prism_dat %>%
  left_join(areas, by = c("x", "y")) %>%
  group_by(year) %>%
  #mutate(covered = if_else(SWE >= 3, area, 0)) %>% # 3mm threshold
    mutate(covered = pmin(1, SWE / 3) * area) %>% # linear decline below 3mm
  summarise(SWE = sum(SWE * area), # units in megaliters (?)
            SCA = sum(covered))

mountains_stats <- prism_dat %>%
  left_join(areas, by = c("x", "y")) %>%
  inner_join(mountains_mask, by = c("x", "y")) %>%
  group_by(year, name) %>%
 # mutate(covered = if_else(SWE >= 3, area, 0)) %>%
  mutate(covered = pmin(1, SWE / 3) * area) %>%
  summarise(SWE = sum(SWE * area), 
            SCA = sum(covered))
```

```{r}
cv_recons <- cv_dat %>%
  mutate(cv = map(cv, ~left_join(., areas, by = c("x", "y")))) %>%
  unnest(cv) %>%
 # mutate(covered = if_else(SWE >= 3, area, 0)) %>%
      mutate(covered = pmin(1, SWE / 3) * area) %>% # linear decline below 3mm
  group_by(k_cera, k_prism, year) %>%
  summarise(SWE = sum(SWE * area), 
            SCA = sum(covered)) %>%
  left_join(wus_stats, by = 'year', suffix = c('_recon', '_obs'))

gc()

range_recons <- cv_dat %>%
  mutate(cv = map(cv, ~left_join(., areas, by = c("x", "y")) %>% 
                    inner_join(mountains_mask, by = c("x", "y")))) %>%
  unnest(cv) %>%
 # mutate(covered = if_else(SWE >= 3, area, 0)) %>%
      mutate(covered = pmin(1, SWE / 3) * area) %>% # linear decline below 3mm
  group_by(k_cera, k_prism, name, year) %>%
  summarise(SWE = sum(SWE * area),
            SCA = sum(covered)) %>%
  left_join(mountains_stats, by = c('year', 'name'), suffix = c('_recon', '_obs'))

gc()
```


```{r}
rmse_dat <- cv_recons %>%
      summarise(SWE_rmse = sqrt(mean((SWE_obs - SWE_recon) ^ 2)),
                SCA_rmse = sqrt(mean((SCA_obs - SCA_recon) ^ 2)))
```

The cross validation routine selects `r rmse_dat[[1, "k_prism"]]` PRISM PCs and  `r rmse_dat[[1, "k_cera"]]` CERA PCs 
```{r}
arrange(rmse_dat, SWE_rmse)
arrange(rmse_dat, SCA_rmse)

rmse_dat %>%
  ggplot(aes(k_cera, k_prism, fill = SWE_rmse)) +
  geom_tile() +
  scale_fill_viridis_c(direction = -1) +
  coord_equal() +
  theme_minimal()

rmse_dat %>%
ggplot(aes(k_cera, k_prism, fill = SCA_rmse)) +
  geom_tile() +
  scale_fill_viridis_c(direction = -1) +
  coord_equal() +
  theme_minimal()
```

So let's truncate the PCs at 4.
```{r, fig.width = 8, fig.asp = .4, echo = FALSE}
e <- prism_dat %>% 
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(4)

f <- cera_dat %>% 
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(4)

e + f
```


```{r, fig.asp = .35}
t1 <- cv_recons %>% filter(k_prism == 4, k_cera == 4) %>%
  gather(type, value, SWE_recon:SCA_obs) %>%
  separate(type, c('var', 'type')) %>%
  mutate(name = 'Western US')

ggplot(t1, aes(year)) +
  geom_line(aes(y = value, color = type)) +
  scale_color_manual(values = c('black', 'red')) +
    facet_wrap(~var, scales = 'free_y') +
  theme_bw()
```


```{r, fig.width = 8}
g <- range_recons %>%
  filter(k_prism == 4, k_cera == 4) %>%
  dplyr::select(-SCA_recon, -SCA_obs) %>%
  rename(recon = SWE_recon, obs = SWE_obs) %>%
  gather(type, SWE, recon:obs) %>%
  ggplot(aes(year)) +
  geom_line(aes(y = SWE, color = type)) +
  scale_color_manual(values = c('black', 'red')) +
  facet_wrap(~name, scales = 'free_y', ncol = 3) +
  theme_bw()

h <- range_recons %>%
  filter(k_prism == 7, k_cera == 9) %>%
  dplyr::select(-SWE_recon, -SWE_obs) %>%
  rename(recon = SCA_recon, obs = SCA_obs) %>%
  gather(type, SCA, recon:obs) %>%
  ggplot(aes(year)) +
  geom_line(aes(y = SCA, color = type)) +
  scale_color_manual(values = c('black', 'red')) +
    facet_wrap(~name, scales = 'free_y', ncol = 3) +
  theme_bw()

g / h + plot_annotation(tag_levels = 'A')
```

```{r, echo = FALSE, eval = FALSE}
# trying to combine above?
t2 <- range_recons %>%
  filter(k_prism == 4, k_cera == 4) %>%
   gather(type, value, SWE_recon:SCA_obs) %>%
  separate(type, c('var', 'type'))

bind_rows(t1, t2) %>%
   ggplot(aes(year)) +
  geom_line(aes(y = value, color = type)) +
  scale_color_manual(values = c('black', 'red')) +
    facet_grid(var~name, scales = 'free_y') +
  theme_bw()
```

#### Local error
```{r}
scores <- cv_dat %>%
  mutate(errors = map(cv, get_errors),
        score_map = map(errors, ~group_by(., x,y) %>% get_scores),
         score_ts = map(errors, ~group_by(., year) %>% get_scores)) %>%
  dplyr::select(-cv, -errors)
```

time
```{r, fig.width=15}
scores %>% mutate(k = interaction(k_prism, k_cera)) %>%
  dplyr::select(k, score_ts) %>%
  unnest(score_ts) %>%
  gather(metric, value, me:rmsle) %>%
  ggplot(aes(year, value)) +
  geom_line(aes(color = k), alpha = .5) +
  facet_wrap(~metric, scales = 'free_y') +
  scale_color_viridis_d() +
  theme_bw() +
  theme(legend.position = 'hide')
```

```{r}
scores %>% mutate(k = interaction(k_prism, k_cera)) %>%
  dplyr::select(k, score_ts) %>%
  unnest(score_ts) %>%
  dplyr::select(k, mdsa, year) %>%
  ggplot(aes(year, mdsa)) +
  geom_line(aes(color = k)) +
  scale_color_viridis_d() +
  theme_bw()
```

```{r}
plot_fun1 <- function(x, name) {
  ggplot(x, aes(k_cera, k_prism, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(direction = -1, name = name) +
  coord_equal() +
  theme_minimal()
}
tmp1 <- scores %>%
  dplyr::select(k_prism, k_cera, score_ts) %>%
  unnest(score_ts) %>%
  group_by(k_prism, k_cera) %>%
  summarise_at(vars(me:rmsle), mean) %>%
  gather(metric, value, me:rmsle) %>%
group_by(metric) %>%
  nest %>%
  mutate(plots = map2(data, metric, plot_fun1))

tmp1$plots
```

space 

```{r}
scores %>%
  dplyr::select(k_prism, k_cera, score_map) %>%
  unnest(score_map) %>%
  dplyr::select(k_prism:y, mdsa, srmse) %>%
  ggplot() +
      geom_raster(aes(x, y, fill = mdsa)) +
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      scale_fill_viridis_c() +
  facet_grid(k_prism~k_cera) +
      theme_void()

#  group_by(k_prism, k_cera) %>%
 # summarise_at(vars(mdsa, srmse), mean, na.rm = TRUE) %>%
  #arrange(mdsa, srmse)
```

```{r}
skill_test <- skill_map %>%
  # add area weighting here
  mutate(rmse_avg = map_dbl(skill_map, ~summarise(., rmse = mean(rmse, na.rm = TRUE)) %>% pull),
         srmse_avg = map_dbl(skill_map, ~summarise(., srmse = mean(srmse, na.rm = TRUE)) %>% pull),
         srmse_sum = map_dbl(skill_map, ~summarise(., srmse_sum = sum(srmse > .8, na.rm= TRUE)) %>% pull)) %>%
  dplyr::select(-skill_map)

arrange(skill_test, rmse_avg)
arrange(skill_test, srmse_avg)
arrange(skill_test, srmse_sum)

ggplot(skill_test, aes(k_cera, k_prism, fill = rmse_avg)) +
  geom_tile() +
  scale_fill_viridis_c(direction = -1) +
  coord_equal() +
  theme_minimal()

ggplot(skill_test, aes(k_cera, k_prism, fill = srmse_avg)) +
  geom_tile() +
  scale_fill_viridis_c(direction = -1) +
  coord_equal() +
  theme_minimal()

ggplot(skill_test, aes(k_cera, k_prism, fill = srmse_sum)) +
  geom_tile() +
  scale_fill_viridis_c(direction = -1) +
  coord_equal() +
  theme_minimal()

```


```{r, warning = FALSE, fig.width = 10, fig.asp = 1}
get_corr_map<- function(x) {
  x %>%
  left_join(prism_dat, by = c('x', 'y', 'year'), suffix = c('_recon', '_obs'))%>%
  group_by(x, y) %>%
  summarise(corr = cor(SWE_recon, SWE_obs)) %>%
  ungroup()
}

cor_map <- cv_dat %>%
  mutate(corr_map = map(cv, get_corr_map)) %>%
  dplyr::select(-cv) %>%
  mutate(corr_sum = map_dbl(corr_map, ~summarise(., corr = sum(corr > 0.3, na.rm = TRUE)) %>% pull)) %>%
  mutate(corr_mean = map_dbl(corr_map, ~summarise(., corr = mean(corr, na.rm = TRUE)) %>% pull)) %>%
    arrange(-corr_sum)

ggplot(cor_map, aes(k_cera, k_prism, fill = corr_sum)) +
  geom_tile() +
  scale_fill_viridis_c() +
  coord_equal() +
  theme_minimal()

ggplot(cor_map, aes(k_cera, k_prism, fill = corr_mean)) +
  geom_tile() +
  scale_fill_viridis_c() +
  coord_equal() +
  theme_minimal()


cor_map %>%
  unnest(corr_map) %>%
ggplot() +
      geom_raster(aes(x, y, fill = corr)) +
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      scale_fill_viridis_c() +
  facet_grid(k_prism~k_cera) +
      theme_void()
```


## EOFs

So let's stick with the 4 and 4 solution, and investigate those patterns more. 
Lets start by truncating at 4. Extract the pc amplitude time series and EOF spatial patterns for the leading 4 modes.

```{r}
n_modes <- 4
```

```{r}
prism_patterns <- get_patterns(prism_dat, k = n_modes)
cera_patterns <- get_patterns(cera_dat, k = n_modes)
```



```{r, echo = FALSE}
plot_amps(prism_patterns) + geom_hline(yintercept = 0, linetype = 2) 
plot_amps(cera_patterns) + geom_hline(yintercept = 0, linetype = 2) 
```

Are the PCs normal? Yes
```{r}
prism_patterns$amplitudes %>%
  group_by(PC) %>%
  nest() %>% 
  pull(data) %>%
  map_dbl(~shapiro.test(c(.$amplitude))$p)
```

Plot the eofs. 
```{r echo = FALSE, fig.asp = 1}
plot_eofs(prism_patterns, 'vik', scaled = FALSE) 
plot_eofs(cera_patterns, 'vik', scaled = FALSE)
plot_eofs(prism_patterns, 'vik', scaled = TRUE) 
plot_eofs(cera_patterns, 'vik', scaled = TRUE)
```

```{r}
# For each PC amplitude time series, plot out the wettest and driest years from the observations.
# From this we can tell that pc1 and 2 need to reverse signs to be physically consistent
extreme_years <- prism_patterns$amplitudes %>%
  group_by(PC) %>%
  filter(amplitude == max(amplitude) | amplitude == min(amplitude)) %>%
  pull(year)

(prism - mean(prism)) %>%
  .[[extreme_years - 1981]] %>%
  setNames(extreme_years) %>%
  as.data.frame(xy = TRUE, na.rm = TRUE) %>%
  gather(year, swe, 3:10) %>%
  mutate(year = factor(year, levels = paste0('X', extreme_years))) %>%
  ggplot(aes(x, y, fill = swe)) +
  geom_raster() +
  facet_wrap(~year) +
  coord_quickmap() +
  scale_fill_distiller(palette = 'BrBG', direction = 1, limits = c(-1500, 1500)) +
  theme_void()
```

## Internal variability

```{r, fig.asp = .9}
prism_recon <- reconstruct_field(prism_patterns)
```

look at the mean and standard deviation of the unexplained variance.
```{r}
resid <- prism_recon %>%
   left_join(prism_dat, by = c('x', 'y', 'year'), suffix = c('_recon', '_obs')) %>%
    mutate(error = SWE_recon - SWE_obs) 

resid %>%
  group_by(x, y) %>%
  summarise(avg = mean(error),
            stdev = sd(error)) %>%
    ggplot() +
  geom_raster(aes(x, y, fill = avg/stdev)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_viridis_c() +
  ggtitle('Error from dimensionality reduction', 'PRISM')
```

```{r}
prism_recon %>%
   get_errors %>%
  group_by(x, y) %>%
  summarise(avg = mean(accuracy_ratio)) %>%
    ggplot() +
  geom_raster(aes(x, y, fill = avg)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_viridis_c() +
  ggtitle('Error from dimensionality reduction', 'PRISM')
```

```{r}
resid %>%
  ggplot(aes(SWE_obs, SWE_recon)) +
  geom_point(alpha = .1) +
  geom_smooth() +
  theme_bw()

resid %>%
  ggplot(aes(SWE_obs, std_resid, color = year)) +
  geom_point(alpha = 0.1) +
  theme_bw()
```


Is it normal?


```{r}
resid %>%
  group_by(x, y) %>%
  summarise(p = shapiro.test(residuals)$p) %>%
  ggplot() +
    geom_raster(aes(x, y, fill = p < 0.05)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_viridis_d() +
  ggtitle('Error from dimensionality reduction', 'PRISM')
```


```{r}
score_map <- prism_recon %>%
  get_errors() %>%
  group_by(x, y) %>%
  get_scores()

score_ts <- prism_recon %>%
  get_errors() %>%
  group_by(year) %>%
  get_scores()
```


```{r, fig.width = 10}
score_ts %>%
  gather(metric, value, me:rmsle) %>%
  ggplot(aes(year, value)) +
  geom_line() +
  facet_wrap(~metric, scales = 'free_y') +
  theme_bw()
```


```{r}
  
  plot_fun <- function(x, name) {
      ggplot(x) +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_viridis_c(name = name)
  }

tmp <- score_map %>%
gather(metric, value, me:rmsle) %>%
group_by(metric) %>%
  nest %>%
  mutate(plots = map2(data, metric, plot_fun))
  gridExtra::grid.arrange(grobs = tmp$plots)
  
  tmp$plots
```


```{r}
prism_recon %>%
    left_join(prism_dat, by = c('x', 'y', 'year'), suffix = c('_recon', '_obs')) %>%
    mutate(SWE_recon = if_else(SWE_recon < .03, .03, SWE_recon),
           SWE_obs = if_else(SWE_obs < .03, .03, SWE_obs),
           error = SWE_recon - SWE_obs,
           relative_error = error / SWE_obs,
           accuracy_ratio = SWE_recon / SWE_obs,
           log_q = log(accuracy_ratio)) %>%
  group_by(x,y) %>%
  get_scores() %>%
  dplyr::select(x,y, mdsa) %>%
        ggplot() +
  geom_raster(aes(x, y, fill = mdsa)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_viridis_c()

prism_recon %>%
    left_join(prism_dat, by = c('x', 'y', 'year'), suffix = c('_recon', '_obs')) %>%
    mutate(SWE_recon = if_else(SWE_recon < .03, .03, SWE_recon),
           SWE_obs = if_else(SWE_obs < .03, .03, SWE_obs),
           error = SWE_recon - SWE_obs,
           relative_error = error / SWE_obs,
           accuracy_ratio = SWE_recon / SWE_obs,
           log_q = log(accuracy_ratio)) %>%
  group_by(x,y) %>%
  get_scores() %>%
  dplyr::select(x,y, sspb) %>%
        ggplot() +
  geom_raster(aes(x, y, fill = sspb)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_viridis_c()
```


```{r}
test <- couple_patterns(cera_patterns, prism_patterns) %>%
  predict_patterns(cera_patterns) %>%
  reconstruct_field(prism_patterns, .) %>%
  inner_join(prism_dat, by = c('x', 'y', 'year'), suffix = c('_recon', '_obs'))

test %>%
  group_by(x, y) %>%
  summarise(corr = cor(SWE_recon, SWE_obs)) %>%
   ggplot() +
      geom_raster(aes(x, y, fill = corr)) +
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      scale_fill_viridis_c() +
      theme_void()

test %>%
   left_join(areas, by = c("x", "y")) %>%
  group_by(x, y) %>%
  summarise(rmse = sqrt(mean((SWE_recon - SWE_obs)^2, na.rm = TRUE)),
            area = mean(area)) %>%
   ggplot() +
      geom_raster(aes(x, y, fill = rmse * area * .001)) + # gigaliters?
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      scale_fill_viridis_c() +
      theme_void()

## values greater than one here would be better represented by a random normal draw, i.e. it is the ratio of the variation unexplained by the regression to the total variance
test %>%
   left_join(areas, by = c("x", "y")) %>%
  inner_join(prism_patterns$climatology) %>%
  group_by(x, y) %>%
  summarise(rmse = sqrt(mean((SWE_recon - SWE_obs)^2, na.rm = TRUE)),
            mae = mean(abs(SWE_recon - SWE_obs)),
            area = mean(area),
            sd = mean(swe_sd),
            pbias = sum(SWE_recon - SWE_obs) / sum(SWE_obs) * 100,
            srmse = rmse/sd,
                        rmsle = sqrt(mean((log(SWE_recon + 1) - log(SWE_obs + 1))^2, na.rm = TRUE))) %>%
   ggplot() +
      geom_raster(aes(x, y, fill = rmsle)) + # gigaliters?
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      scale_fill_viridis_c() +
      theme_void()


   ggplot(prism_patterns$climatology) +
      geom_raster(aes(x, y, fill = swe_sd)) + # gigaliters?
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      scale_fill_viridis_c() +
      theme_void()
   
test %>%
     group_by(x, y) %>%
  mutate(SWE_recon = if_else(SWE_recon < 5, 0, SWE_recon),
         SWE_obs = if_else(SWE_obs < 5, 0, SWE_obs)) %>%
     summarise(xbar = mean(SWE_obs),
               mse = mean((SWE_recon - SWE_obs)^2, na.rm = TRUE),
               mse_clim = sum((SWE_obs - xbar)^2, na.rm = TRUE) * (1 / (n() - 1)) * ((n() - 1) / n()),
               msss = 1 - mse / mse_clim,
               rmse = sqrt(mse),
               rmse_cv = rmse / xbar) %>% 
        ggplot() +
      geom_raster(aes(x, y, fill = msss)) +
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      scale_fill_viridis_c() +
      theme_void()
```

The 4 pc model underpredicts snow in areas with very low accumulation, which makes sense because of the use of the covariance matrix earlier.
```{r}
test %>%
     group_by(x, y) %>%
      summarise(obs = all(SWE_obs < 0.05),
             recon = all(SWE_recon < 0.05)) %>%
  gather(test, value, obs:recon) %>%
        ggplot() +
      geom_raster(aes(x, y, fill = value)) + # gigaliters?
      geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~test) +
      scale_fill_viridis_d() +
      theme_void()
```

```{r}

test %>%
     mutate(error = SWE_recon - SWE_obs) %>%
  group_by(x, y) %>%
  summarise(avg = mean(error),
            std = sd(error)) %>%
        ggplot() +
      geom_raster(aes(x, y, fill = avg)) + # gigaliters?
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      scale_fill_distiller(palette = 'RdBu', limits = c(-120, 120)) +
      theme_void()

test %>%
     mutate(error = SWE_recon - SWE_obs) %>%
  group_by(x, y) %>%
  summarise(avg = mean(error),
            std = sd(error)) %>%
        ggplot() +
      geom_raster(aes(x, y, fill = avg)) + # gigaliters?
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      scale_fill_distiller(palette = 'RdBu', limits = c(-120, 120)) +
      theme_void()
```

## Trends

Are there any trends?

```{r}
trends_mod <- prism_patterns$amplitudes %>%
  mutate(PC = paste0('PC', PC)) %>% 
  group_by(PC) %>%
  nest() %>%
  mutate(mod = map(data, ~gam(amplitude ~ 
                                s(year, k = 4), 
                              data = ., 
                              method = 'REML', 
                              select = TRUE))) %>%
  mutate(r2 = map_dbl(mod, ~summary(.)$r.sq)) %>%
  mutate(data = map2(data, mod, add_predictions),
         data = map2(data, mod, add_residuals)) 

walk(trends_mod$mod, plot)
```


# Coupled Pattern Analysis

First look at just the error from the dimensionality reduction  with the PCs. This is basically the error in the pc targets, so is the minimum error we'd get even from the best downscaling

## GAM

Let's look under the hood of what the GAM models above were doing.
```{r}
gam_mod <- couple_patterns(cera_patterns, prism_patterns)
```

```{r}
walk(gam_mod$model$mod, plot)
```

How do the models perform?
```{r}
gam_mod$model %>%
  dplyr::select(PC, r2) %>%
  arrange(-r2)
```

Are the residuals autocorrelated? Some are
```{r}
gam_mod$data %>%
  group_by(PC) %>%
  summarise(autocor = cor(resid, lag(resid), use = 'pairwise.complete.obs')) %>%
  arrange(-abs(autocor))
```

```{r}
ggplot(gam_mod$data, aes(resid)) +
  #geom_histogram() + 
  geom_density(fill = NA) +
  geom_vline(xintercept = 0, color = 'red', linetype = 2) +
  facet_wrap(~PC) +
  theme_bw()
```

```{r}
gam_recon <- predict_patterns(gam_mod, cera_patterns) %>%
  reconstruct_field(prism_patterns, .)
```

```{r}
gam_recon %>%
filter(between(year, 1982, 1987)) %>% 
ggplot() +
  geom_raster(aes(x, y, fill = anomaly)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  facet_wrap(~year) +
  scale_fill_scico(palette = 'vik', direction = -1, limits = c(-1300, 1300)) +
  ggtitle('Observed mean April 1st SWE, 1982-2017', 'PRISM')

prism_dat %>%
    group_by(x, y) %>%
  mutate(SWE_mean = mean(SWE),
         anomaly = SWE - SWE_mean) %>% 
filter(year <= 1987) %>%
ggplot() +
  geom_raster(aes(x, y, fill = anomaly)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  facet_wrap(~year) +
  scale_fill_scico(palette = 'vik', direction = -1, limits = c(-1300, 1300)) +
  ggtitle('Observed mean April 1st SWE, 1982-2017', 'PRISM')
```


```{r}
gam_recon %>%
  left_join(prism_dat, by = c('x', 'y', 'year')) %>%
  mutate(error = SWE.x - SWE.y) %>%
filter(between(year, 1982, 1987)) %>%
ggplot() +
  geom_raster(aes(x, y, fill = error)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  facet_wrap(~year) +
  #scale_fill_scico(palette = 'vik', direction = -1, limits = c(-450, 450)) +
  ggtitle('Observed mean April 1st SWE, 1982-2017', 'PRISM')
```


```{r}
knitr::knit_exit()
```

## CCA

```{r}
t1 <- prism_patterns$amplitudes %>%
  filter(year <= 2010) %>%
  spread(PC, amplitude) %>%
  dplyr::select(-year) %>%
  as.matrix() %>%
  scale()

t2 <- cera_patterns$amplitudes %>%
  filter(year >= 1982) %>% 
    spread(PC, amplitude) %>%
  dplyr::select(-year) %>%
  as.matrix() %>%
  scale()

can_cor<- cancor(t1, t2, xcenter = FALSE, ycenter = FALSE) # pcs already centered
```

```{r}
can_cor$cor
```

```{r}
cera_can <- cera_patterns$eofs %>%
  dplyr::select(-value) %>%  # use normalized or unnormalized?
  spread(EOF, weight) %>%
  dplyr::select(-x, -y) %>%
  as.matrix() %>%
  `%*%`(can_cor$ycoef) %>%
    `colnames<-`(paste0('PC', 1:n_modes)) %>%
  as_tibble()
  
prism_can <- prism_patterns$eofs %>%
  dplyr::select(-value) %>%
  spread(EOF, weight) %>%
  dplyr::select(-x, -y) %>%
  as.matrix() %>%
  `%*%`(can_cor$xcoef) %>%
  `colnames<-`(paste0('PC', 1:n_modes)) %>%
  as_tibble()
```

```{r}
cera_dat %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  dplyr::select(x, y, column) %>%
  bind_cols(cera_can) %>%
  gather(pattern, value, starts_with('PC')) %>% 
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern) +
      scale_fill_scico(palette = 'broc', direction = -1, limits = c(-1, 1) * 8) +
  theme_void()+
  coord_sf() +
  ggtitle('Reanalysis CCA')

prism_dat %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  dplyr::select(x, y, column) %>%
  bind_cols(prism_can) %>%
  gather(pattern, value, starts_with('PC')) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern) +
      scale_fill_scico(palette = 'broc', direction = -1, limits = c(-1, 1) * 80) +
  theme_void()+
  coord_sf() +
  ggtitle('Observed CCA')
```

```{r}
plot_cancor <- function(x1, x2, y1, y2){
  p1 <- x1 %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  dplyr::select(x, y, column) %>%
  bind_cols(x2) %>%
  gather(pattern, value, starts_with('PC')) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern) +
  scale_fill_distiller(palette = 'RdBu') +
  theme_void()+
  #coord_quickmap() +
  ggtitle('Reanalysis CCA') +
    theme(legend.position = 'bottom')

p2 <- y1 %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  dplyr::select(x, y, column) %>%
  bind_cols(y2) %>%
  gather(pattern, value, starts_with('PC')) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern) +
  scale_fill_distiller(palette = 'RdBu') +
  theme_void()+
  #coord_quickmap() +
  ggtitle('Observed CCA') +
  theme(legend.position = 'bottom')

p1 + p2
}

plot_cancor(cera_dat, cera_can, prism_dat, prism_can)
```


```{r}
library(telefit)

t1 <- prism_dat %>%
  filter(year <= 2010) %>%
  spread(year, SWE) %>%
  dplyr::select(-x, -y) %>%
  as.matrix()

t2 <- cera_dat %>%
  filter(year >= 1982) %>% 
  spread(year, SWE) %>%
  dplyr::select(-x, -y) %>%
  as.matrix()

any(is.infinite(t2))

t3 <- prism_dat %>%
  filter(year <= 2010) %>%
  spread(year, SWE) %>%
  dplyr::select(x, y)

tele.preds <- cca.predict(t2, t1, t2, k.x = 7, k.y = 4)
1 - var(as.numeric(tele.preds-t1)) / var(as.numeric(t1))
```

it looks like for some reason the cca.predict function isn't rescaling correctly? or its just meant to work with standardized anomalies?

```{r}
prism_scaler <- prism_dat %>%
  group_by(x,y) %>%
  summarise(avg = mean(SWE), sdev = sd(SWE, na.rm = TRUE))
```

```{r}
prism_dat %>%
  filter(year <= 2010) %>%
  snow_only() %>%
  spread(year, SWE) %>%
  dplyr::select(x, y) %>%
  cbind(tele.preds) %>%
  gather(year, SWE, `1982`:`2010`) %>%
  left_join(prism_scaler) %>%
  mutate(SWE = SWE * sdev + avg) %>%
  filter(year <=1984) %>%
  ggplot(aes(x,y)) +
  geom_raster(aes(fill = SWE)) +
  facet_wrap(~year) +
  coord_quickmap()
```


```{r}
cca.predict

scale(t2) %>% is.infinite %>% any
```


## EOTs

```{r}
eot1 <- cera_dat %>%
  filter(year >= 1982) %>%
  spread(year, SWE) %>%
  rasterFromXYZ() %>%
  anomalize() %>%
  denoise(expl.var = .85, weighted = TRUE)

eot2 <- prism_dat %>%
  filter(year <= 2010) %>%
  spread(year, SWE) %>%
  rasterFromXYZ() %>%
  anomalize() %>% 
  denoise(expl.var = .85, weighted = TRUE)
```

```{r}
telecon <- eot(eot1, eot2, n = 6)
```


```{r}
walk(1:6, ~plot(telecon, y = ., show.bp = TRUE))
```

```{r}
predict(telecon, eot1) %>% .[[1]] %>% `+`(mean(prism)) %>% plot
```


# Validation


```{r}
anomaly_dat <- prism_dat %>%
  filter( year <= 2010) %>% # important to make sure everything's calculated on the same time scale, may be best to do this further up?
  group_by(x, y) %>%
  mutate(swe_mean = mean(SWE),
         swe_sd = sd(SWE, na.rm = TRUE),
         anomaly = SWE - swe_mean) %>%
  ungroup()

tele_dat <- tele.preds %>%
  as_tibble() %>%
  bind_cols(t3, .) %>%
  gather(year, tele_pred, `1982`:`2010`) %>%
  mutate(year = as.numeric(year)) %>%
  left_join(anomaly_dat)  %>%
  mutate(swe_pred = tele_pred * swe_sd + swe_mean,
         res = swe_pred - SWE) 
```

```{r, echo = FALSE}
tele_dat %>%
  filter(year < 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = tele_pred)) +
  scale_fill_viridis_c() +
  facet_wrap(~year) +
  coord_quickmap()

tele_dat %>%
  filter(year < 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = anomaly)) +
  scale_fill_distiller(palette = 'RdBu') +
  facet_wrap(~year) +
  coord_quickmap()
```

```{r, echo = FALSE}
tele_dat %>%
  filter(year == 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = swe_mean)) +
  scale_fill_viridis_c() +
  facet_wrap(~year) +
  coord_quickmap()

tele_dat %>%
  filter(year == 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = swe_sd)) +
  scale_fill_viridis_c() +
  facet_wrap(~year) +
  coord_quickmap()
```

```{r}
plot(mean(prism));plot(calc(prism, sd))
```

```{r}
tele_dat %>%
  mutate(test = tele_pred * swe_sd + swe_mean) %>%
    filter(year == 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = test)) +
  scale_fill_viridis_c() +
  facet_wrap(~year) +
  coord_quickmap()

tele_dat %>%
  mutate(test = tele_pred * swe_sd + swe_mean) %>%
    filter(year == 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = SWE)) +
  scale_fill_viridis_c() +
  facet_wrap(~year) +
  coord_quickmap()
```

```{r}
tele_dat %>%
  mutate(swe_pred = tele_pred * swe_sd + swe_mean,
         error = swe_pred - SWE) %>%
      filter(year < 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = error)) +
  scale_fill_distiller(palette = 'RdBu') +
  facet_wrap(~year) +
  coord_quickmap()
```

```{r}
t7 <- prism_dat %>%
  filter(year <= 2010) %>%
  spread(year, SWE) %>%
  rasterFromXYZ()

eot_rmse <- (predict(telecon, eot1) + mean(t7) - t7)^2 %>%
  cellStats(stat = 'mean') %>%
  sqrt()

cca_rmse <- tele_dat %>%
  mutate(swe_pred = tele_pred * swe_sd + swe_mean,
         error = swe_pred - SWE) %>% 
  group_by(year) %>%
  summarise(rmse = sqrt(mean(error ^ 2))) 

gam_rmse <- gam_recon %>%
  left_join(prism_dat, by = c('x', 'y', 'year')) %>%
  mutate(error = SWE.x - SWE.y) %>%
  group_by(year) %>%
  summarise(rmse = sqrt(mean(error ^ 2))) 

left_join(gam_rmse, cca_rmse, by = 'year') %>%
  mutate(eot_rmse = eot_rmse) %>%
  gather(method, rmse, rmse.x:eot_rmse) %>%
  ggplot(aes(year, rmse)) +
  geom_line(aes(color = method))
```

So the gam is in part effective here because it resolves recent snow droughts ... I wonder if this is a global warming trend?
```{r}
tele_dat %>%
  filter(year == 2005 ) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = anomaly)) +
  scale_fill_distiller(palette = 'RdBu', limits = c(-1100, 1100)) +
  facet_wrap(~year) +
  coord_quickmap()
```


```{r}
test2 <- tele.preds %>%
as_tibble() %>%
  bind_cols(t3, .) %>%
  rasterFromXYZ() 

plot(((test2 * calc(prism, sd) + mean(prism)) - prism )[[24]])
```

```{r}
plot(mean(prism) - prism)
mean(prism) - prism

tele.preds %>%
  as.tibble() %>%
  bind_cols(t3, .)
```
