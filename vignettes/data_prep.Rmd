---
title: "data_prep"
author: "Nick Gauthier"
date: "2/26/2020"
output: html_document
---


```{r setup}
library(raster) # processing raster data
library(tidyverse) # data manipulation and visualization
library(sf)
```

## Geographic Data

Define a study area to constrain all computations.
```{r}
bbox <- extent(c(-125, -102, 31, 49))
```

Import the snow observation data from https://nsidc.org/data/nsidc-0719.^[What's up with this warning message? long_name=CRS definition
spatial_ref=GEOGCS["NAD83",DATUM["North_American_Datum_1983",SPHEROID["GRS 1980",6378137,298.257222101,AUTHORITY["EPSG","7019"]],AUTHORITY["EPSG","6269"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.01745329251994328,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4269"]]
GeoTransform=-125.0208 0.04166662697178698 0 49.9375 0 -0.04166662697178698]. 

```{r}
preprocess <- function(x, var, bbox, flip = FALSE, regrid = FALSE, daily = FALSE) {
  maps <- brick(x, varname = var)

  indices <- getZ(maps) %>% # find the index for April 1st
    str_detect('-03-')%>%
    which()

  raster::subset(maps, indices) %>%
    {if(flip) rotate(.) else .} %>%
    crop(bbox) %>%
    {if(daily) mean(.) else .} %>%
    {if(regrid) aggregate(., fact = 2) else .} # resample to lower res to speed up analysis
}
```

```{r message=FALSE,warning=FALSE}
prism <- list.files('../data', pattern = 'SWE_Depth', full.names = TRUE) %>%
  map(preprocess, var = 'SWE', bbox = bbox, regrid = TRUE, daily = TRUE) %>%
  brick() %>%
  setNames(1982:2017)
```


```{r, warning = FALSE}
# this averages over the full ensemble
cera <- map(1:10,
            ~ (brick('../data/CERA-20C_snow.nc', varname = 'rsn', level = .) *
                 brick('../data/CERA-20C_snow.nc', varname = 'sd', level = .))) %>%
  reduce(`+`) %>%
  `/`(10) %>%
  crop(bbox)
```

```{r}
cesm_h2osno <- preprocess('~/Downloads/b.e11.BLMTRC5CN.f19_g16.001.clm2.h1.H2OSNO.08500101-18491231.nc',
                          var = 'H2OSNO',
                          flip = TRUE,
                          bbox = bbox)

cesm_h2osno_ext <- preprocess('~/Downloads/b.e11.BLMTRC5CN.f19_g16.001.clm2.h1.H2OSNO.18500101-20051231.nc',
                          var = 'H2OSNO',
                          flip = TRUE)

cesm_areas <- area(cesm_h2osno) %>%
  as.data.frame(xy = TRUE, na.rm = TRUE) %>%
  rename(area = layer)

cesm <- c(cesm_h2osno, cesm_h2osno_ext) %>%
  brick()
```


```{r}
livneh <- preprocess('~/Downloads/LIVNEH/swe.mon.mean.nc', var = 'swe', bbox = bbox, flip = TRUE, regrid = TRUE)
```

```{r}
terraclim <- brick('~/Downloads/agg_terraclimate_swe_1958_CurrentYear_GLOBE.nc', varname = 'swe')
```

## supplemental data
```{r}
# download state boundary files for cropping and plotting
state_names <- c('arizona', 'new mexico', 'colorado', 
                 'california', 'utah', 'nevada', 
                 'oregon', 'washington', 'idaho',
                 'wyoming', 'montana')

states_wus <- maps::map('state', regions = state_names, 
                    fill = TRUE, plot = FALSE) %>% st_as_sf

prism_mask <- prism[[1]] %>% mask(states_wus) %>% as.data.frame(na.rm = TRUE, xy = TRUE) %>% .[,1:2]
cera_mask <- cera[[1]] %>% mask(states_wus) %>% as.data.frame(na.rm = TRUE, xy = TRUE) %>% .[,1:2]
livneh_mask <- livneh[[1]] %>% mask(states_wus) %>% as.data.frame(na.rm = TRUE, xy = TRUE) %>% .[,1:2]
terraclim_mask <- terraclim[[1]] %>% mask(states_wus) %>% as.data.frame(na.rm = TRUE, xy = TRUE) %>% .[,1:2]

areas <- area(prism) %>%
  as.data.frame(xy = TRUE, na.rm = TRUE) %>%
  rename(area = layer)

mountains <- read_sf('../data/ne_10m_geography_regions_polys.shp') %>%
  filter(name %in% c('SIERRA NEVADA', 'CASCADE RANGE', 'ROCKY MOUNTAINS')) %>%
  dplyr::select(name, geometry)

mountains_mask <- mountains %>% 
  mutate(rasters = split(., 1:3) %>% map(~mask(prism[[1]], .))) %>%
  st_drop_geometry() %>%
  mutate(rasters = map(rasters, as.data.frame, na.rm = TRUE, xy = TRUE)) %>%
  unnest(rasters) %>%
  dplyr::select(-X1982)
```


## Preprocessing
```{r}
snow_only <- function(dat){
  dat %>%
    group_by(x, y) %>%
    mutate(test = all(near(SWE, 0) | is.na(SWE))) %>%
    filter(test == FALSE) %>%
    ungroup() %>%
    dplyr::select(-test)
}
```

Turn the raster bricks into data frames and join.
```{r}
prism_dat <- prism %>%
  as.data.frame(xy = TRUE, na.rm = TRUE, long = TRUE) %>%
  mutate(year = round(parse_number(layer))) %>%
  rename(SWE = value) %>%
  dplyr::select(-layer) %>%
  snow_only() %>%
  semi_join(prism_mask, by = c('x', 'y'))
```

```{r}
cera_dat <- cera %>%
  as.data.frame(xy = TRUE, na.rm = TRUE, long = TRUE) %>%
  mutate(year = round(parse_number(layer))) %>%
  rename(SWE = value) %>%
  dplyr::select(-layer) %>%
  snow_only()  %>%
  semi_join(cera_mask, by = c('x', 'y'))
```


still need to account for snow fraction of grid cell? and land fraction too?

```{r}
cesm_dat <- cesm %>%
  as.data.frame(xy = TRUE, na.rm = TRUE, long = TRUE) %>%
  mutate(year = str_sub(layer, 2) %>% parse_number() %>% round) %>%
  rename(SWE = value) %>%
  select(-layer) %>%
  left_join(cesm_areas, by = c('x', 'y'))
```

```{r}
livneh_dat <- livneh %>%
  as.data.frame(xy = TRUE, na.rm = TRUE, long = TRUE) %>%
  mutate(year = round(parse_number(layer))) %>%
  rename(SWE = value) %>%
  dplyr::select(-layer) %>%
  snow_only()  %>%
  semi_join(livneh_mask, by = c('x', 'y'))
```

```{r}
terraclim_dat <- terraclim %>%
  as.data.frame(xy = TRUE, na.rm = TRUE, long = TRUE) %>%
  mutate(year = lubridate::year(Z)) %>%
  rename(SWE = value) %>%
  dplyr::select(-Z) %>%
  snow_only() %>%
  semi_join(terraclim_mask, by = c('x', 'y'))
```


```{r}
save(prism_dat, cera_dat, areas, mountains_mask, states_wus, file = '../data.Rdata')
```
